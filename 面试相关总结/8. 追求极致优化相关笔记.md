33. 如何开展优化类工作
    ```
    面试官视角：这类题想考察什么？
        1. 是否对项目整体目标有清晰认识(高级)
        2. 是否能对项目的重点问题进行拆解(高级)
        3. 是否有追求极致的技术和主观意愿(技术强，但是面对问题得过且过也不好)(高级)
        4. 是否能够在关键时刻承担有挑战的工作(高级)
    题目剖析：
        1. 通常作为大项目的重点专项存在
        2. 对整个项目具有系统性、全局性的认识，此类工作一般属于系统性全局性的局部工作
        3. 可以凸显追求极致的精神
    题目结论：答题模板(按照模板的思路按需(自己的项目经历)答题)
        明确优化目标：
            优化方向：
                耗电量优化？
                过度绘制优化？
                内存优化？
                CPU占用率优化？
                算法策略优化？
            优化目标：
                定性(咱们App耗电量太高，需要优化！)————>定量(后台运行 10%/小时，目标 3%/小时)
            注：体现你能确立清晰的优化目标，而不是想当然的开展优化
        定位关键问题：优化占比最高的问题
        二八定律：80% 的错误通常源自于 20%的问题
            -优化前期花 20%的精力就能解决 80%的问题
            -优化后期则相反
        业内横向对比：体现你考虑问题比较全面，而不是盲目造轮子(若生态中已有现成解决方案，只是方案有些许地方不适合，则可通过优化修改现有方案，而不是单纯的造轮子)
        完善指标监控：对应用的性能、业务可靠性进行线上的监控和预警
        灰度上线：按产品需求优先级，抽出核心需求，在满足用户基本要求的情况下快速上线，并通过限制流量、白名单等机制进行产品试用，以此收集用户的意见，从而萃取出用户潜在的需求，形成后续更有针对性的设计方案。
            和传统研发模式相比，这么做唯一的区别就在于将原先一锅粥式的需求和功能点进行了轻重缓急的排序，并以此将项目从原来的单长线作战转化为多迭代短线循环，让产品的生命周期不再昙花一现。
            如此一来，需求分析阶段显得尤为关键，我们必须清晰的将需求按优先级归纳分类为几个序列，如：p1,p2,p3…核心功能和必备的体验在p1序列，辅助功能点和辅助型体验列在p2序列，争执不定的需求点可以放在p3序列。
            需求排序后，我们可以将项目发布点有序的分成（>2期），第一期只确保主要的核心功能和基础体验快速灰度上线，随后通过用户访谈、产品的tracker&session数据、业务数据等手段分析出用户对产品的真实反应，并以此调整二期需求，该加的加，该砍的砍，做到有的放矢。
        项目收益：转换成面试官有概念的指标
            -页面加载时间减少 800ms
            -内存消耗降低 50MB
            -CPU占有率由 12%降低至 3%
            -项目成本降低xxx
        人力优化：
            优化目标：
                1. 主要针对项目负责人
                2. 需要对项目成员的能力有足够的了解
                3. 需要对项目功能做合理的拆解
                4. 用合适的人做合适的事
                5. 适当放权，但也要依据情况做好指导
            优化心法：
                1. 深入钻研技术为优化提供可能
                2. 结合业务场景为优化提供落脚点
                3. 熟悉团队特点为优化提供战斗力
        不好的例子：
            简历：项目当中用到一个 xxx 算法来加密，加密过程中比较耗时，为了优化性能，我采用并发的方式来提升算法的速度。
            面试官提问：
                Q1：你的程序是IO密集型还是CPU密集型
                答：CPU密集型
                Q2：为什么CPU密集型的程序可以通过并发提升效率？
                答：因为...耗时主要是因为算法结果需要插入数据库，由于数据量比较大，IO耗时比较长，应该是IO密集型的。
                答解析：CPU密集型程序，证明CPU基本一刻也不会闲着，而现在开多个线程只会增大CPU的压力，因为线程之间的切换是有开销的。
                Q3：再想想，是加密过程耗时还是入库耗时
                答：入库耗时，这里写错啦..
                Q4：并发一定能提升运行速度吗？你的线程开了多少个？
                答：能吧，开了三个。
                Q5：如果设备是单核CPU呢？
                答：额..没想过
                答解析：多线程的用处在于，做某个耗时的操作时，需要等待返回结果，这时用多线程可以提高程序并发程度。如果一个不需要等待的CPU密集的任务,效率提升不明显.但是如果是IO操作比较多，CPU计算比较少,即使是单核CPU,应用了多线程技术后对外也会表现一定性能提升(实质为提高了碎片时间的利用率)
        不好的例子--技术优化：
            简历：项目当中用到一个 xxx 算法来加密，加密过程中比较耗时，为了优化性能，优化了算法，耗时减少 40%
            面试官提问：
                Q1：你是怎么优化这个算法的？
                答：1. 这个算法本身涉及到大量的矩阵运算，在Java层运行我发现会导致频繁gc，因此我在算法运行时做了一些小矩阵的池化，减少对象的频繁创建和gc，耗时减少 20%
                   2. 后来考虑到算法的可移植性，我用 c 重写了，发现单次计算耗时比Java版本又减少 20%，一是内存直接使用物理内存，减少gc，二是算法执行过程中需要频繁与底层函数交互，c版本将原来jni调用变成了直接调用，降低了开销。由于我们这个算法的调用频次不高，因此c版本接口层引入的jni调用开销可以忽略不计。
        不好的例子--业务优化：
            简历：项目当中用到一个 xxx 算法来加密，加密结果数据较大，入库比较耗时。我对整个业务流程进行了优化，减少IO的耗时，同时也在合适的情况下开启多线程操作IO，提升运行效率。
            面试官提问：
                Q1：你是怎么优化这个业务流程的？
                答：1. 加密结果较大是源数据较大导致的，源数据由前序业务生产环节产生。我与相关同时经过探讨，在不影响业务的前提下优化了数据格式，将JSON格式的源数据修改为Protobuf进行加密，源数据减少了 60%。
                   2. 源数据存储于sqlite，实验发现其二进制读写性能不如文件直接读写，因此同样不影响源数据的情况下直接从文件系统读取，性能提升 5%。
                   3. 将算法做了优化，确保安全的前提下，由原先的全文件加密改为局部加密，文件不需要完整加载和回写，直接随机读写文件系统就可以解决，IO耗时减少 90%。
        本节回顾：
            1. 探讨了优化类项目开展和阐述的关键思路
                -量化指标，完成从定性到定量的转变
                -定位问题，二八定律与关键问题的解决
                -横向对比，避免遭到为什么自己造轮子的挑战
                -完善监控，优化效果有据可查
                -项目收益，给出听得懂的收益指标
                -人力优化，合适的活给合适的人
            2. 结合一个不好的例子并给出改进方案
    ```
34. 一个算法策略优化Case：
    ```
    优化方向：
        -结果确定性：主要是性能优化
        -结果模糊性：受样本影响大，算法本身的优化
    算法模糊优化：
        优化前的项目状况
            -指标：xxx准确率，例如：语音识别准确率
            -量化方案：无，主要凭感觉
            -策略验证方案：无
        优化：
            量化指标：
                -给出xxx准确率的数学定义和计算方法
                -建立指标获取、策略验证的流程和方法
                -搜集建立充足的样本集得到指标的现状
                -确定合理的KPI，例如从 78% 优化到 92%
            对比现有技术方案：
                -阅读相关学术论文
                -与相关经验的团队进行技术交流
            监控体系建设：
                -针对算法效果的指标 xxx准确率做监控
                -根据项目特征确定指标汇报频率
                -定期发送线上运营数据报表，展现项目效果
            算法策略动态下发：
                算法迭代--> 动态下发(插件化或者脚本化)--> 算法生效
            工具完善：人工-->自动指标量化-->辅助问题定位
            灰度上线：
                -初期：线上数据离线核验，项目核心用户灰度
                -中期：线上数据离线核验，线上用户30%灰度
                -后期：逐步全量推送
                灰度发布（又名金丝雀发布）是指在黑与白之间，能够平滑过渡的一种发布方式。在其上可以进行A/B testing，
                即让一部分用户继续用产品特性A，一部分用户开始用产品特性B，如果用户对B没有什么反对意见，那么逐步扩大范围，
                把所有用户都迁移到B上面来。灰度发布可以保证整体系统的稳定，在初始灰度的时候就可以发现、调整问题，以保证其影响度。
    本节回顾：
        -指标量化：确定计算方法、制定目标
        -问题定位：分析问题、方案对比
        -问题解决：解决 80% 的问题、追求极致
        -项目收益：直接收益，宏观收益
    ```
35. 一个工程技术的优化Case
    ```
    项目背景：一个视频截图SDK的效率优化工作(输入视频和时间戳，截图)
        视频格式：
            编码格式
            封装格式：举例
                MP4：索引 + 视频数据
                Mpeg2-Ts文件：... + 同步信息 + 视频数据 + 同步信息 + 视频数据 + ...
        帧：I-关键帧/P-依赖于前面关键帧/B-不仅依赖于前面关键帧，还依赖后面帧
    优化前的项目状况：
        量化指标：单张图像截取耗时
        验证策略：选择大量样本随机截帧计算耗时
    对比现有技术方案：
        MediaMetadataRetriever：Android系统 API
        FFmpegMediaMetadataRetriever：基于FFmpeg封装，接口与系统对齐
        基于FFmpeg自研：基于FFmpeg，可按需求定制

        方案类型            系统原生                FFmpeg
        支持格式            较少                   常见所有格式
        兼容性              受线于硬件和系统，较差    基本没有兼容性问题
        MP4                约1.5s                约1.1s(目标帧只占很小比例)
        TS                 1.3s，有偏差且无法获取   3s，无偏差(大量时间用于寻址)
        内部逻辑            不可控，不可定制         可控，可定制
    解码器选择：优先硬件解码，可根据设备情况动态切换
        方案类型            硬件解码            软件解码
        支持类型            较少                常见所有格式
        兼容性              受限于硬件，较差      非常好，已于扩展
        解码速度            非常快              相对较慢
    开源框架License
    优化方案：
        1. 纯技术优化：TS快速寻址
        2. 结合业务的优化点：
            -I帧近似
            -编解码流程优化
    ```