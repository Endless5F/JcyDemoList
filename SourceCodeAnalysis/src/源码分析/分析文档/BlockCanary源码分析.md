主流开源框架源码深入了解第5篇——BlockCanary源码分析。(源码以1.5.0版为准)

## UI卡顿原理
问：为什么16ms没完成绘制就会卡顿？

我们先来了解几个概念：
1. Android系统每隔16ms就会重新绘制一次Activity，因此，我们的应用必须在16ms内完成屏幕刷新的全部逻辑操作，每一帧只能停留16ms，否则就会出现掉帧现象(也就是用户看到的卡顿现象)。
2. 16ms = 1000/60hz，相当于60fps(每秒帧率)。这是因为人眼与大脑之间的协作无法感知超过60fps的画面更新。12fps大概类似手动快速翻书的帧率，这个速度明显可以感知是不够顺滑的。24fps使得人眼感知的是连续线性运动，24fps是电影胶圈通常使用的帧率，这个帧率可以支撑大部分电影画面需要表达的内容。但是低于30fps是无法顺畅表现绚丽的画面内容，此时需要使用60fps来达到想要的效果。因此，如果应用没有在16ms内完成屏幕刷新的全部逻辑操作，就会发生卡顿。
3. Android不允许在UI线程中做耗时的操作，否则有可能发生ANR的可能，默认情况下，在Android中Activity的最长执行时间是5秒，BroadcastReceiver的最长执行时间则是10秒，Service前台20s、后台200s未完成启动。如果超过默认最大时长，则会产生ANR。

答：Android系统每隔16ms就会发出VSYNC信号，触发对UI进行渲染，VSYNC是Vertical Synchronization(垂直同步)的缩写，可以简单的把它认为是一种定时中断。在Android 4.1中开始引入VSYNC机制。为什么是16ms？因为Android设定的刷新率是60FPS(Frame Per Second)，也就是每秒60帧的刷新率，约16ms刷新一次。这就意味着，我们需要在16ms内完成下一次要刷新的界面的相关运算，以便界面刷新更新。举个例子，当运算需要24ms完成时，16ms时就无法正常刷新了，而需要等到32ms时刷新，这就是丢帧了。丢帧越多，给用户的感觉就越卡顿。

正常流畅刷新图示：
![](https://user-gold-cdn.xitu.io/2019/11/26/16ea83e59a79899a?w=800&h=365&f=png&s=86744)

哎呀！丢帧啦。卡顿图示：
![](https://user-gold-cdn.xitu.io/2019/11/26/16ea83ea26c99105?w=800&h=400&f=png&s=78005)

## BlockCanary原理
